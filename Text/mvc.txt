from app import *
from report import *
import tkinter as tk
from tkinter import ttk

class View:

    def PythonGUI(self):

        self.root = tk.Tk()
        self.root.title("Mission Control")
        self.root.geometry("800x600")

        self.frame = ttk.Frame(self.root)
        self.frame.pack(fill=tk.BOTH, expand=True)

        self.missionLbl = ttk.Label(self.frame, text="Mission Control Panel", font=("Helvetica", 16))
        self.missionLbl.pack(pady=10)

        controls = ttk.Frame(self.frame)
        controls.pack(fill=tk.X, pady=10)
        self.RetrieveMissionbtn = ttk.Button(controls, text="Retrieve Missions")
        self.RetrieveMissionbtn.pack(pady=10)
        self.GenerateBtn = ttk.Button(controls, text="Generate Report")
        self.GenerateBtn.pack(pady=20)

        ttk.Label(self.frame, text="Select Mission:").pack(anchor="w", pady=(12,4))
        listwrap = ttk.Frame(self.frame)
        listwrap.pack(fill=tk.BOTH, expand=True)
        self.MissionSelect = ttk.Label(self.frame, text="Select Mission:")
        self.MissionSelect.pack(pady=5)
        self.MissionList = tk.Listbox(listwrap, height=12)
        self.MissionList.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        scrollbar = ttk.Scrollbar(listwrap, orient=tk.VERTICAL, command=self.MissionList.yview)
        scrollbar.pack(side=tk.RIGHT, fill=tk.Y)
        self.MissionList.config(yscrollcommand=scrollbar.set)
   
        self.StatusLbl = ttk.Label(self.root, text="Status: â€”")
        self.StatusLbl.pack(fill=tk.X, pady=4)


class Controller:
    def __init__(self, view, model):
        self.__view = view
        self.__model = model
        

    def run(self):
        self.__view.PythonGUI()
        self.__view.RetrieveMissionbtn.config(command=self.generate_MissionList)
        self.__view.GenerateBtn.config(command=self.generate_Report)

        self.update_status()

        self.__view.root.mainloop()   
    
    def generate_MissionList(self):
        keys = self.__model.list_mission_keys()
        n = self.__view.MissionList
        n.delete(0, tk.END)
        if not keys:
            self.__view.StatusLbl.config(text="Status: No Missions found.")
            return
        for key in keys:
            n.insert(tk.END, key)
        self.__view.StatusLbl.config(text=f"Status: Retrieved {len(keys)} Missions.")

    def generate_Report(self):
        Selection=self.__view.MissionList.curselection()

        if not Selection:
            self.__view.StatusLbl.config(text="Status: Please Select Mission.")
            return
        
        MissionKey=self.__view.MissionList.get(Selection[0])

        self.__view.StatusLbl.config(text=f"Status: Mission Report generated {MissionKey}")

    def update_status(self):
        stat = self.__model.health()   
        Db_Api_status =(bool(stat["db_ok"]), bool(stat["api_ok"]))
       
        match Db_Api_status:      
            case (True, True):
                txt = "Status: Connected (DB Good, API Good)"
            case (True, False):
                txt = "Status: Partial (DB Good, API Bad)"
            case (False, True):
                txt = "Status: Partial (DB Bad, API Good)"
            case _:
                txt = "Status: Disconnected (DB Bad, API Bad)"
        self.__view.StatusLbl.config(text=txt)
        
class Model:
    App=App()
    App.setup()

    def list_mission_keys(self):
        return list(App().redis_client.scan_iter(match="Mission*"))

    
    def health(self):
        return {"db_ok": False, "api_ok": False}

    
